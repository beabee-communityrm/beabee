# üêù beabee

This repository hosts beabee's API and legacy app. [Go here](https://beabee.io/en/home/) to find out more about beabee.

If you are interested/have any questions please contact
will.franklin@beabee.io, I'd love to hear from you!

This system was originally created for
[South London Makerspace](http://southlondonmakerspace.org)
and repurposed by [The Bristol Cable](https://thebristolcable.org).

![Deploy](https://github.com/beabee-communityrm/beabee/workflows/Deploy/badge.svg)
![Known Vulnerabilities](https://snyk.io/test/github/beabee-communityrm/beabee/badge.svg?targetFile=package.json)

## üíª Install

> ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è **WARNING** ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
>
> If you want to deploy beabee on a server refer to
> [beabee/beabee-deploy](https://github.com/beabee-communityrm/beabee-deploy/)
> instead. The instructions below are for running beabee locally for development

You need:

- Docker >= 19.03.8
- Docker Compose >= 2
- Node.js >= 20.10.0

NOTE: Lower non-major versions probably work but haven't been tested

To just look around the system you can just use the example env file (`.env.example`) as is, but you'll need to
create a sandbox GoCardless account to test any payment flows.

```bash
cp .env.example .env

npm install
npm run build
docker compose build

# Initialise database
docker compose up -d db
docker compose run --rm app npm run typeorm migration:run

# Do the rest
docker compose up -d
```

Go to: http://localhost:3001

### To get started

#### Create a new super admin

```bash
docker compose run --rm app node built/tools/new-user
```

#### Import some data

Need some test data? Download it here: coming soon

```bash
docker compose run --rm -T app node built/tools/database/import.js < <import file>
```

## `</>` Development

Development is containerized, in general you should be able to use the following to get started

```bash
npm start
```

You can also use the following when just working on the API (faster reloading)

```bash
npm run dev:api
```

#### Rebuilding containers

If you make changes to `.env` you need to recreate the Docker containers

```
docker compose up -d
```

If you change the dependencies in `package.json` you must rebuild and recreate the Docker containers

```
docker compose build
docker compose up -d
```

#### Generating database migrations

Whenever you make changes to a database model, you need to create a migration
file. TypeORM will automatically generate a migration file based on your schema
changes

```
docker compose start db
docker compose run app npm run typeorm migration:generate src/migrations/MigrationName
npm run build
docker compose run app npm run typeorm migration:run
```

> Note: If you get an `EACCES: permission denied` error, you may need to run the above commands with `docker compose run -u root`.

### üì∞ Documentation

Documentation is currently very limited, email [will.franklin@beabee.io](mailto:will.franklin@beabee.io) if you have any questions.

The codebase is broadly split into a few different parts

- **beabee core**

  Shared between all services (API, webhooks and legacy)

  ```
  ./src/core
  ./src/models - Data models and database entities
  ./src/config - Config loader
  ```

- **API service**
  ```
  ./src/api
  ```
- **Webhook service**

  Handlers for webhooks from beabee's integrations (currently GoCardless, Mailchimp and Stripe)

  ```
  ./src/webhook
  ```

- **Legacy app**

  This is slowly being removed, with business logic being moved into the API and frontend into the [new frontend](https://github.com/beabee-communityrm/beabee-frontend/).

  ```
  ./src/apps
  ./src/static
  ./src/views
  ```

- **Tools**

  Various tools for administration, including nightly cron jobs

  ```
  ./src/tools
  ```

- **Database migrations**

  Autogenerated by TypeORM

  ```
  ./src/migrations
  ```

#### ü§≤ Common Package

The backend and frontend share some code through the [beabee-common](https://github.com/beabee-communityrm/beabee-common) NPM package. To contribute to the common codebase, follow these steps to clone, build, and link it to this project:

```sh
git clone https://github.com/beabee-communityrm/beabee-common.git
cd beabee-common
npm install
npm run build
npm link
```

Now you can link the common package to this project

```sh
npm link @beabee/beabee-common
```

Now you can make any changes to the common package and they will be reflected in this project.

#### üì° Webhooks

Webhooks are handled by the `webhook_app` service. This is a separate service from the API to allow for scaling independently.

**`/webhook/ping`** - Used to check if the webhook service is running and available, e.g. http://localhost:3001/webhook/ping

**`/webhook/stripe`** - Stripe webhooks are handled by the `stripe` service, see [Payment Providers](#payment-providers) for more information.

**`/webhook/gocardless`** - GoCardless webhooks are handled by the `gocardless` service, see [Payment Providers](#payment-providers) for more information.

**`/webhook/mailchimp`** - Mailchimp webhooks are handled by the `mailchimp` service, see [MailChimp](#mailchimp) for more information.

```bash
docker compose exec app node built/tools/configure
stripe listen --forward-to http://localhost:3001/webhook/stripe
```

### üìß E-Mail

#### Prepare for local development

By default we are using [MailDev](https://github.com/maildev/maildev) for local development. For this to work it must be configured the first time, run the following command:

```bash
docker compose exec app node built/tools/configure
```

#### üìÆ MailChimp

MailChimp is used for sending newsletters and other marketing emails.

To be able to send emails you need to create a MailChimp account and create a new API key in the [MailChimp dashboard](https://mailchimp.com/).

The API key can be found in the MailChimp dashboard under the API keys section.

### üí∞ Payment Providers

We are using stripe for membership payments.

#### Prepare for local development

Make shure you have defined the environment variables in the .env file:

```bash
BEABEE_STRIPE_PUBLICKEY=<public key>
BEABEE_STRIPE_SECRETKEY=<secret key>
```

You can get the public key and secret key in the [Stripe dashboard](https://dashboard.stripe.com).

To be able to recive webhooks from stripe you need to forward them to your local environment and create a webhook secret using the [Stripe CLI](https://docs.stripe.com/stripe-cli):

```bash
stripe login
stripe listen --forward-to localhost:3001/webhook/stripe
```

Now the stripe CLI prints out the webhook secret, copy it and add it to the .env file while you keep the forwarding process running:

```bash
BEABEE_STRIPE_WEBHOOKSECRET=<webhook secret>
```

> ‚ö†Ô∏è To be able to create a payment in the frontend you need to be able to recive confirmation emails, so make shure you have setup [E-Mail](#email).

> ‚ö†Ô∏è Since the enviroment variable has changed you also need to [rebuild the containers](#rebuilding-containers).

## ü§ù Advertising

Browser testing with<br/>
<a href="https://www.browserstack.com/"><img src="https://user-images.githubusercontent.com/2084823/46341120-52388b00-c62f-11e8-8f41-270915ccc03b.png" width="150" /></a>
