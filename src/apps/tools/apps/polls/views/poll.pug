extends /views/base.pug

block prepend title
	- title = 'Poll'

block append css
	link(rel='stylesheet' href='https://unpkg.com/formiojs@latest/dist/formio.full.min.css')
	style.
		.formcomponents { position: sticky; top: 1rem }

mixin candidateSchema(candidateNo, candidate)
	li.js-repeater-item
		.form-group
			label.control-label.col-md-2 Name
			.col-md-10
				input(type='text' name=`formSchema[candidates][${candidateNo}][name]` value=candidate.name required).form-control
		.form-group
			label.control-label.col-md-2 Bio
			.col-md-10
				textarea(name=`formSchema[candidates][${candidateNo}][bio]` required).form-control= candidate.bio
		p.text-right
			button(type='button').btn.btn-sm.btn-danger.js-repeater-remove-item Remove


block prepend js
	if poll.formTemplate === 'ballot'
		script(type='text/template').js-repeater-template
			+candidateSchema(0, {})

block append js
	if poll.formTemplate === 'builder'
		script(src='https://unpkg.com/formiojs@latest/dist/formio.full.min.js')
		script.
			Formio.builder(
				document.getElementById('builder'),
				!{JSON.stringify(poll.formSchema || {})},
				{template: 'bootstrap3'}
			).then(function (builder) {
				builder.on('change', function() {
					$('.js-poll-form-schema').val(JSON.stringify(builder.schema));
				});
			});

block contents
	.row
		.col-md-12
			+page_header(poll.question)

			dl.dl-horizontal
				dt Status
				dd
					if poll.active
						span.label.label-success Active
					else if poll.closed
						span.label.label-danger Closed
					else if poll.expires
						span.label.label-warning Expired
					else if poll.starts
						span.label.label-info Scheduled
				dt Created
				dd= moment(poll.date).format('DD/MM/YYYY [at] HH:mm')
				dt Update answers?
				dd= poll.allowUpdate ? 'Yes' : 'No'
				dt URL
				dd
					a(href='/polls/' + poll.slug)= '/polls/' + poll.slug
					|
					|
					if !poll.active
						a(href='/polls/' + poll.slug + '?preview=1').btn.btn-xs.btn-default Preview
				dt Responses
				dd
					= pollAnswersCount
					|
					|
					a(href='/tools/polls/' + poll._id + '/responses').btn.btn-xs.btn-default See responses

			hr

	.row
		.col-md-8
			h4 Update poll
			include partials/poll-form

	.row
		.col-md-12
			hr

			h4 Edit form

			- formSchema = poll.formSchema || {}

			if poll.formTemplate === 'builder'
				#builder

				form(method='POST')
					+csrf
					input(type='hidden' name='formSchema' value=JSON.stringify(formSchema)).js-poll-form-schema
					button(name='action' value='edit-form').btn.btn-primary Save

			else if poll.formTemplate === 'ballot'
				form(method='POST').form-horizontal
					+csrf

					h5 Settings

					.form-group
						label.control-label.col-md-2 Key ballot info
						.col-md-10
							textarea(name='formSchema[ballotInfo]').form-control= formSchema.ballotInfo
					.form-group
						label.control-label.col-md-2 Min votes
						.col-md-2
							input(type='number' name='formSchema[minVotes]' value=formSchema.minVotes).form-control
					.form-group
						label.control-label.col-md-2 Max votes
						.col-md-2
							input(type='number' name='formSchema[maxVotes]' value=formSchema.maxVotes).form-control

					h5 Candidates

					ul(data-name='formSchema[candidates]').repeater.js-repeater
						if formSchema.candidates
							each candidate, candidateNo in formSchema.candidates
								+candidateSchema(candidateNo, candidate)
					p: button(type='button').btn.btn-default.js-repeater-add-item Add candidate

					p: button(name='action' value='edit-form').btn.btn-primary Save

			else
				.row
					.col-md-8
						.alert.alert-warning This poll's form cannot be edited

			hr

	.row
		.col-md-8

			h4 Delete poll

			form(method='POST')
				+csrf
				p
					label.checkbox-inline
						input(type='checkbox' required)
						| This change is irreversible, confirm to proceed
				button(name='action' value='delete').btn.btn-danger.outline Delete
