extends /views/notrack.pug

block prepend title
	- title = 'GoCardless'
	- page = 'gocardless'

mixin commonSubscriptionFields(idPrefix, periodReadOnly)
	+input( 'number', 'Monthly amount', 'amount', {
		left: 3, right: 4, before: 'Â£',
		value: member.contributionMonthlyAmount,
		id: idPrefix + 'Amount'
	})
	if periodReadOnly
		.form-group
			label.col-md-3.control-label Period
			.col-md-4.form-control-static= member.contributionPeriod
	else
		+input( 'radio', 'Period', 'period', {
			left: 3, right: 4,
			options: {'monthly': 'Monthly', 'annually': 'Annually'},
			value: member.contributionPeriod,
			id: idPrefix + 'Period'
		})
	+input( 'checkbox', 'Paying fee', 'payFee', {
		left: 3, right: 4,
		options: {'true': 'Yes'},
		value: member.gocardless.paying_fee,
		id: idPrefix + 'PayFee'
	})

block contents
	.row
		.col-md-3
			include partials/sidebar.pug
		.col-md-9
			+page_header( title )

			h4= member.hasActiveSubscription ? 'Update contribution' : 'Start contribution'
			if !member.canTakePayment
				.alert.alert-warning User does not have an active payment method
			else if !canChange
				.alert.alert-warning Can't change contribution at the moment, probably due to pending payments
			else
				form( method="post").form-horizontal
					+csrf
					input( type='hidden' name='action' value='update-subscription' )
					+commonSubscriptionFields('update', member.hasActiveSubscription)

					if monthsLeft > 0
						.form-group
							label(for='prorate').col-md-3.control-label Prorate
							.col-md-9
								.checkbox
									label
										input(type='checkbox' value='true')#prorate
										|  Yes
										|
										small (#{monthsLeft} months left until next payment)

					+form_button( member.hasActiveSubscription ? 'Update' : 'Start', 'success', { left: 3 } )

			h4 Manual update
			.alert.alert-danger.
				If done incorrectly this could result in payments being taken but not
				recorded
			form( method="post" ).form-horizontal
				+csrf
				input( type='hidden' name='action' value='force-update' )
				+input( 'text', 'Customer ID', 'customer_id', { value: member.gocardless.customer_id, left: 3, right: 4 } )
				+input( 'text', 'Mandate ID', 'mandate_id', { value: member.gocardless.mandate_id, left: 3, right: 4 } )
				+input( 'text', 'Subscription ID', 'subscription_id', { value: member.gocardless.subscription_id, left: 3, right: 4 } )
				+commonSubscriptionFields('force', false)
				+form_button( 'Update', 'danger', { left: 3 } )
